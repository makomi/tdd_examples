# Adapt this file to your project as needed.
# CppUTest manual: https://cpputest.github.io/manual.html


############
# settings #
############

# CppUTest directory (path relative to this Makefile)
# Only necessary, if CppUTest was NOT system installed via e.g. apt-get.
CPPUTEST_HOME = CppUTest

# code directories
SRC_DIR = ./src
TEST_DIR = ./test

# file names
MAIN = main
MODULE = module
UNITTESTS = UnitTests

# general compiler options
CFLAGS  = -g
CFLAGS += -Wall
CFLAGS += -Wextra
CFLAGS += -std=c99
#CFLAGS += -pedantic
#CFLAGS += -Werror
#CFLAGS += -Wshadow
#CFLAGS += -Wstrict-overflow

# compiler options for CppUTest
# CPPFLAGS works for both .c and .cpp files!
CPPFLAGS = -I$(CPPUTEST_HOME)/include

# Linker options that add CppUTest libraries to the linker flags.
LD_LIBRARIES  = -L$(CPPUTEST_HOME)/lib
LD_LIBRARIES += -lCppUTest
# This flag is only needed, if you want to use extensions such as mocking.
LD_LIBRARIES += -lCppUTestExt


#################
# build targets #
#################

# default target
all : $(SRC_DIR)/$(MAIN).out $(TEST_DIR)/$(UNITTESTS).out

# application
$(SRC_DIR)/$(MAIN).out : $(SRC_DIR)/$(MAIN).o $(SRC_DIR)/$(MODULE).o
	$(CC) $^ $(CPPFLAGS) $(CFLAGS) -o $(SRC_DIR)/$(MAIN).out

$(SRC_DIR)/$(MAIN).o : $(SRC_DIR)/$(MAIN).c

$(SRC_DIR)/$(MODULE).o : $(SRC_DIR)/$(MODULE).c

# unit tests
$(TEST_DIR)/$(UNITTESTS).out : $(TEST_DIR)/$(UNITTESTS).cc $(SRC_DIR)/$(MODULE).o
	$(CXX) $^ $(CPPFLAGS) -o $(TEST_DIR)/$(UNITTESTS).out $(LD_LIBRARIES)


###############
# run targets #
###############

# application
main : $(SRC_DIR)/$(MAIN).out
	@$(SRC_DIR)/$(MAIN).out

# unit tests
test : $(TEST_DIR)/$(UNITTESTS).out
	@$(TEST_DIR)/$(UNITTESTS).out


################
# misc targets #
################

# delete files generated by make
clean :
	rm -f $(SRC_DIR)/$(MAIN).out $(TEST_DIR)/$(UNITTESTS).out $(SRC_DIR)/*.o $(TEST_DIR)/*.o

# display synopsis
help :
	@echo "make [all]     compile everything, i.e application and tests"
	@echo "make clean     remove all files generated by make"
	@echo ""
	@echo "make main      compile and run application"
	@echo "make test      compile and run tests"

